#!/bin/bash

# WASSUP_COOKIE='4342414435393434413337423731463437464139334435314343374535423945563d56322020202039323038303139363030303030316230303234303830303030303766303030303030303030303766307a354b37614873424d69456c5748557533684645385a4366545a695450526b434a44434c61424638772f6b34795444324d643033483073356f6435514d597175682b6b7a662f666241754969337a6835665a68576f4d5064374b43716f6939797139655952472f4473485144586e474768585554463433396a792b7548746e746c77344b54396754753175472b3875766877677a524d3168315331595479714872427151664141726736484264516b75525a5573366b356b526d444d6f4f6c66597a6c567341752b736e752f687459667577304e6b436b716865714e4d39417734466e454c5644354b4e37654f4f4d414c4d306c496f64665355346e72456e682f487553547248674150686e4f55326b47434e756f4556534d7a5349587463384531696355316f755a65307738337a3858787a61646d4272375071584a7975514e433562512b48466a7a55414132566c746369536133744854743268356b4a3349462f4539444f5a7151506d6b627535766a45785a574c333250414457446a38704c56323136306d44532b52425472447538534e4c6e704a6c3953776441524f732f4645515551413141786342445048694233647444473131626747334d3455554163763450326946616c2b7672513532702b4368786c31764878416343733674692f76467a67714735594a2f505567644d564f513151792b766641454d665a58655a68746b4e3133707771446a4c796a2b645556324530412f684a6f456943643743416d486e65372f33412f63486a6d70502b44794b643861494d3867797c4d434f3d4f46527c563d56347c585f5741535355505f415554485f4d4554483d337c585f5741535355505f53594e435f434f4f4b49453d3638343333357c585f5741535355505f56414c49445f444154453d32303231303930323039323530367c616f6c3d307c7761643d32303231303330323039323530367c7763743d324d4a4c6f5270454b6c47674a78746e776644714e503954335869635868396142'

TOKEN='6bb57935b9620f8608cc8e681ef89d074a2bf7982934d5f13c72771c69b7e50f524945168b0b923c1d7cd75132d182bd219b7b576780395d5c9fdbc76e0e1baa44d4868de21d41630b73621d18e7b5fb69e4ee08c86f1f492b740a223e4e9456c363af037937269abbca1944792141'

API_URL=https://api.webxms.orange.fr/api/v8

# login() {
#     curl --silent "$API_URL/token" \
#          -H "x-xms-service-id: OMI" \
#          -H "Cookie: wassup=$WASSUP_COOKIE"
# }

# me() {
#     curl --silent "$API_URL/users/me"\
#          -H "x-xms-service-id: OMI" \
#          -H "Authorization: Bearer $TOKEN"
# }

# free_sms_left() {
#     LEFT=$(jq ".dailyQuota | .freeSmsLeft")
#     test "$LEFT" && test "$LEFT" != 0
# }

send_sms() {
    MSG="$1"
    DST="$2"
    curl --silent --globoff "$API_URL/users/me/messages" \
         -H "x-xms-service-id: OMI" \
         -H "Authorization: Bearer $TOKEN" \
         -H "Content-type: application/json" \
         --data-raw "$(echo '{"content":"'$MSG'",'\
                             '"recipients":["'$DST'"],'\
                             '"replyType":"mobile",'\
                             '"messageId":"0"}')"
}





# MAIN
if test "$1"; then
    MSG="$1"
else
    read -r MSG
fi
# TODO
DST="${2:-+33686303272}"

if ! test "$MSG"; then
    echo "Usage: $0 MSG [DST]" 1>&2
    exit 42
fi

if (($(wc -c <<< "$MSG") >= 160)); then
    echo "Message too long, truncate..."
    MSG=$(sed -E 's/^(.{159}).*/\1/' <<< "$MSG")
fi

# echo "Login..."
# TOKEN=$(login | jq -r .token)

# echo "Checking quotas..."
# if ! me | free_sms_left; then
#     echo "No free sms left, abort."
#     exit 42
# fi


echo "Sending '$MSG' to $DST..."
send_sms "$MSG" "$DST" | jq
